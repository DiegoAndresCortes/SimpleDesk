<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
	<id>SimpleDeskTeam:SimpleDesk</id>
	<version>2.0</version>

	<file name="$sourcedir/Profile-Modify.php"><!-- Ensure things get uncached if we change groups (which means permissions) -->
		<operation>
			<search position="after"><![CDATA[	// The account page allows the change of your id_group - but not to a protected group!]]></search>
			<add><![CDATA[	// Ensure we uncache stuff that might change in the helpdesk
	shd_clear_active_tickets();

]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Errors.php"><!-- if an error occurs in an SD file, log it appropriately with the SD errortype -->
		<operation>
			<search position="after"><![CDATA[	// Make sure the category that was specified is a valid one]]></search>
			<add><![CDATA[	// Is this a SimpleDesk error?
	$known_error_types[] = 'simpledesk';
	$known_error_types[] = 'sdplugin';
	if (stripos($file, 'sdplugin') !== false || stripos($error_message, 'shdp_') !== false)
		$error_type = 'sdplugin';
	elseif (stripos($file, 'simpledesk') !== false || stripos($error_message, 'shd_') !== false || stripos($error_message, 'simpledesk') !== false)
		$error_type = 'simpledesk';

]]></add>
		</operation>
	</file>

	<file name="$boarddir/SSI.php"><!-- Load SimpleDesk SSI functions -->
		<operation>
			<search position="before"><![CDATA[require_once($sourcedir . '/Security.php');]]></search>
			<add><![CDATA[
require_once($sourcedir . '/sd_source/SimpleDesk-SSI.php');]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Subs-BoardIndex.php"><!-- Board integration -->
		<operation>
			<search position="before"><![CDATA[$smcFunc['db_free_result']($result_boards);]]></search>
			<add><![CDATA[

	// Are we adding any SimpleDesk boards in?
	if (!empty($modSettings['helpdesk_active']) && empty($modSettings['shd_disable_boardint']) && shd_allowed_to('access_helpdesk'))
	{
		global $sourcedir;
		require_once($sourcedir . '/sd_source/Subs-SimpleDeskBoardIndex.php');
		shd_add_to_boardindex($boardIndexOptions, $categories);
	}]]></add>
		</operation>
	</file>

	<file name="$sourcedir/ManageMaintenance.php"><!-- at the same time we modify the post settings, make sure we check and update SD's if necessary -->
		<operation>
			<search position="replace"><![CDATA[
			$smcFunc['db_change_column']('{db_prefix}messages', 'body', array('type' => 'mediumtext'));]]></search>
			<add><![CDATA[
		{
			$smcFunc['db_change_column']('{db_prefix}messages', 'body', array('type' => 'mediumtext'));
			$smcFunc['db_change_column']('{db_prefix}helpdesk_ticket_replies', 'body', array('type' => 'mediumtext'));
		}]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
			$smcFunc['db_change_column']('{db_prefix}messages', 'body', array('type' => 'text'));]]></search>
			<add><![CDATA[
		{
			$smcFunc['db_change_column']('{db_prefix}messages', 'body', array('type' => 'text'));
			$smcFunc['db_change_column']('{db_prefix}helpdesk_ticket_replies', 'body', array('type' => 'text'));
		}]]></add>
		</operation>
		<!-- @todo: add the check for tickets longer than xxx chars -->
	</file>

	<file name="$sourcedir/ManageLanguages.php"><!-- Language file handling -->
		<operation>
			<search position="after"><![CDATA[	// Check we have themes with a path and a name - just in case - and add the path.]]></search>
			<add><![CDATA[	// Add SimpleDesk to the list of possible places to look.
	$themes['shd'] = array('name' => 'SimpleDesk', 'theme_dir' => $settings['default_theme_dir'] . '/languages/sd_language');
	$lang_dirs['shd'] = $settings['default_theme_dir'] . '/languages/sd_language';
	$themes['shd_plugins'] = array('name' => 'SimpleDesk Plugins', 'theme_dir' => $settings['default_theme_dir'] . '/languages/sd_plugins_lang');
	$lang_dirs['shd_plugins'] = $settings['default_theme_dir'] . '/languages/sd_plugins_lang';

]]></add>
		</operation>
	</file>
</modification>